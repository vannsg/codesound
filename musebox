<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="codingSoundFavicon.ico" />

    <title>MusicBox03</title>

    <!--import Tone.js, link found here: https://cdnjs.com/libraries/tone-->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/15.1.5/Tone.min.js"></script>

    <!--import the webpage's stylesheet-->
    <link rel="stylesheet" href="style.css" />


</head>

<body>
    <!-- this is the start of content -->
    <h1>Music Box 03</h1>

    <!--create a button named play-btn-->
    <button id="play-btn">Play</button>

    <!--display text-->
    <p>Make sure your volume is up</p>

    <p>
        Check some boxes and hit play <br />
        (or the other way around)
    </p>
    <div>
        <div>
            <input type="checkbox" />
            <input type="checkbox" />
            <input type="checkbox" />
            <input type="checkbox" />
            <input type="checkbox" />
            <input type="checkbox" />
            <input type="checkbox" />
            <input type="checkbox" />
        </div>
        <br />
        <div>
            <input type="checkbox" />
            <input type="checkbox" />
            <input type="checkbox" />
            <input type="checkbox" />
            <input type="checkbox" />
            <input type="checkbox" />
            <input type="checkbox" />
            <input type="checkbox" />
        </div>
        <br />
        <div>
            <input type="checkbox" />
            <input type="checkbox" />
            <input type="checkbox" />
            <input type="checkbox" />
            <input type="checkbox" />
            <input type="checkbox" />
            <input type="checkbox" />
            <input type="checkbox" />
        </div>
    </div>
    </div>
    <canvas id="soundCanvas" width="400" height="400"></canvas>
    <br />
    <style>
    canvas {
      background-color: blue;
      display: block;
      margin: 50px auto;
      border: 2px solid black;
    }
</style>
     </div>
    <br />
    <p>
        Pitch Slider
    </p>

    <!--creates slider, from 1 to 5, incrementing 0.1, defaulting to 3 (with some style)-->
    <input type="range" id="pitchShift" min="1" max="5" step="0.1" value="3" style="width: 190px;">

    <br />
    <br />

    <!--create a button named rando voce-->
    <button id="rando-btn">Rando Voce</button>

    <br />
    <br />

    <p>
Distortion:
    </p>
<!--radio buttons control cheby-->

<div style="display:flex; gap:12px; align-items:center;">
    <label><input type="radio" name="order" value="1" checked> None</label>
    <label><input type="radio" name="order" value="10"> Type 1</label>
    <label><input type="radio" name="order" value="19"> Type 2</label>
</div>


    <!--BOTTOM-->
    <!--Nav Buttons-->
    <div class="button-row">
        <button class="left" onclick="location.href='index.html'">ToC</button>
        <button class="center"
            onclick="window.open('https://github.com/Interactimation/coding-sound/blob/main/MusicBox03.html', '_blank')">Code</button>
        <button class="right" onclick="window.open('lesson05.html')">Next</button>
    </div>

    <br />
    <br />

    <!--JAVASCRIPT-->

    <script>

        /* 
        STEP SEQUENCER
        * Based on: https://www.youtube.com/watch?v=Dxxkma4F-oA
        * Discover: 
        ** 1: Oscillators are sound wave generators and these waves can have different shapes. Read up about them: https://www.perfectcircuit.com/signal/difference-between-waveforms and maybe try one we're not using, below
        ** 2. IMPORTANT Gain refers the magnitude of a signal, note that we're using Tone.Gain and setting it to 0.2 (it goes from 0 to 1) WHEN USING CERTAIN OSCILLATORS (SQUARE, FOR INSTANCE) SET GAIN LOW - otherwise you may damage user speakers or hurt their ears!
        * Challenge: take out the filters or change them, choose different notes, use different synths
        */

        //SETUP SOME EFFECTS

        //FeedbackDelay
        const fbDelay = new Tone.FeedbackDelay({
            delayTime: 0.2,
            feedback: 0.1,
            wet: 0.3,
        });

        //AutoWah
        const autWah = new Tone.AutoWah({
            gain: 0.5,
            octaves: 4,
            sensitivity: 0.5,
            wet: 0.3,
        })


        //Reverb
        const rev = new Tone.Reverb({
            decay: 6,
            preDelay: 0,
            wet: 0.75,
        })

        //Chebyshev

        let chebord = 1;
       
      let cheby = new Tone.Chebyshev({
            order: chebord,        
            oversample: "2x", 
            wet: 0.3
        });

        
        //instantiate Synths
        const synths = [
            new Tone.Synth(),
            new Tone.Synth(),
            new Tone.Synth()
        ];

        //create an array of sound wave types, called 'voices'
        let voice = [
            'triangle',
            'sine',
            'sawtooth',
            'square',
        ]

        //pick a random integer between 0 and 3, inclusive 
        let v0 = Math.floor(Math.random() * 4);
        let v1 = Math.floor(Math.random() * 4);
        let v2 = Math.floor(Math.random() * 4);

        //give each synth a different oscillator
        synths[0].oscillator.type = voice[v0];
        synths[1].oscillator.type = voice[v1];
        synths[2].oscillator.type = voice[v2];

        //gain is incredibly important here, without this rather low setting, the sounds created by different oscillators could be ear-splitting and even damage speakers
        const gain = new Tone.Gain(0.5);

        //connect each synth to the Feedback Delay, connect that to the Auto Wah, connect that to Gain and send that to the speakers —AGAIN, SET GAIN LOW!
        synths.forEach(synth => synth.connect(fbDelay));
        fbDelay.connect(autWah);
        autWah.connect(rev);
        rev.connect(cheby);
        cheby.connect(gain);
        gain.toDestination();

        //get pitchShift
        const slider = document.getElementById("pitchShift");

        let shifter = 3;

        //look at the body of the page (HTML) get all the divs that are children of divs (in our HTML we have three divs which are inside (children of) an outer div)) and apply a different note to each
        let $rows = document.body.querySelectorAll('div > div'),
            notes = [174.6 * shifter, 164.8 * shifter, 110 * shifter];

        //if slider value changes, update notes

        slider.addEventListener("input", () => {
            if (slider.value) {
                shifter = parseFloat(slider.value);
                notes = [174.6 * shifter, 164.8 * shifter, 110 * shifter];


                console.log(shifter);
            }
        });

        //create an index we can increase 
        let index = 0;

        //play through the rows and then do it again, etc —I'll admit some of this is new to me!
        Tone.Transport.scheduleRepeat(repeat, '8n');

        function repeat(time) {
            let step = index % 8;
            for (let i = 0; i < $rows.length; i++) {
                let synth = synths[i],
                    note = notes[i],
                    $row = $rows[i],
                    $input = $row.querySelector(`input:nth-child(${step + 1})`);
                if ($input.checked) synth.triggerAttackRelease(note, '8n', time);
            }
            index++;
        }

        //listen to the radio buttons and chose no distortion (1) or between an even or an odd number
 
         document.querySelectorAll('input[name="order"]').forEach(radio => {
                radio.addEventListener("change", e => {
                    if (e.target.checked) {
                        chebord = parseInt(e.target.value, 10);
                        cheby.order = chebord;
                        console.log("chebord =", chebord);
                    }
                });
            });

        //get the play button, when it's clicked, if the Tone.context.state is NOT "running" then start it, if it is, then stop it —oh and change the text in the button based on what will happen when it's next clicked!

        const playBTN = document.getElementById("play-btn");
        let isPlaying = false;
        playBTN.addEventListener("click", async () => {
            await Tone.start(); // ensures context is unlocked on any click

            if (!isPlaying) {
                Tone.Transport.start();
                playBTN.textContent = "Pause";
                isPlaying = true;
            } else {
                Tone.Transport.pause();
                playBTN.textContent = "Play";
                isPlaying = false;
            }
        });

        const canvas = document.getElementById("soundCanvas");
    const ctx = canvas.getContext("2d");
    
 canvas.addEventListener
      const rect = canvas.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;
        //get rando button
        const vocBTN = document.getElementById("rando-btn");
        vocBTN.addEventListener("click", async () => {

            //pick a random integer between 0 and 3, inclusive 
            let v0 = Math.floor(Math.random() * 4);
            let v1 = Math.floor(Math.random() * 4);
            let v2 = Math.floor(Math.random() * 4);

            //give each synth a different oscillator
            synths[0].oscillator.type = voice[v0];
            synths[1].oscillator.type = voice[v1];
            synths[2].oscillator.type = voice[v2];
        });

    </script>

</body>

</html>
